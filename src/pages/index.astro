---
import Layout from '../layouts/Layout.astro';
import Pong from '../components/games/Pong.astro';
---

<Layout title="Goobface // Space">
    <div class="relative min-h-screen overflow-hidden bg-[#050510] text-white selection:bg-cyan-500 selection:text-black">
        
        <!-- Interactive Space Background -->
        <canvas id="space-canvas" class="absolute inset-0 w-full h-full pointer-events-auto"></canvas>

        <!-- Content Layer (z-index to float above canvas) -->
        <main class="relative z-10 pointer-events-none">
            
            <!-- Navbar / Header -->
            <header class="w-full p-6 flex justify-between items-center pointer-events-auto">
                <div class="text-2xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">
                    GOOBFACE
                </div>
                <nav class="flex gap-4 text-sm font-medium">
                    <a href="https://github.com/kelvinbward/goobface" target="_blank" class="hover:text-cyan-400 transition-colors">GitHub</a>
                </nav>
            </header>

            <!-- Hero Section -->
            <section class="max-w-6xl mx-auto px-6 pt-12 pb-24 text-center">
                <div class="inline-block mb-4 px-3 py-1 bg-cyan-500/10 border border-cyan-500/30 rounded-full text-cyan-400 text-xs font-mono tracking-widest pointer-events-auto">
                    SYSTEM STATUS: OPTIMAL
                </div>
                
                <h1 class="text-7xl md:text-9xl font-black mb-6 tracking-tight text-transparent bg-clip-text bg-gradient-to-b from-white to-white/50 animate-fade-in pointer-events-auto">
                    EXPLORE
                    <br />
                    THE VOID
                </h1>
                
                <p class="text-lg md:text-xl text-blue-200/60 max-w-2xl mx-auto mb-12 leading-relaxed pointer-events-auto">
                    Interactive experiments in digital physics and web entertainment.
                    <br />
                    Click anywhere to ignite the stars.
                </p>

                <!-- Game Island -->
                <div id="games" class="pointer-events-auto max-w-4xl mx-auto">
                    <div class="bg-black/40 backdrop-blur-xl border border-white/10 rounded-3xl p-1 shadow-2xl shadow-cyan-900/20">
                        <div id="game-container" class="bg-[#0a0a0a] rounded-[22px] overflow-hidden relative group flex flex-col">
                            <!-- Header: Removed absolute positioning to restore layout flow -->
                            <div class="p-4 border-b border-white/5 flex items-center justify-between bg-white/5">
                                <div class="flex gap-2 items-center">
                                    <button id="close-btn" class="w-3 h-3 rounded-full bg-red-500/50 hover:bg-red-400 flex items-center justify-center text-[8px] text-black font-bold transition-colors cursor-pointer" title="Close">
                                        &times;
                                    </button>
                                    <button id="minimize-btn" class="w-3 h-3 rounded-full bg-yellow-500/50 hover:bg-yellow-400 flex items-center justify-center text-[8px] text-black font-bold transition-colors cursor-pointer" title="Minimize">
                                        -
                                    </button>
                                    <button id="fullscreen-btn" class="w-3 h-3 rounded-full bg-green-500/50 hover:bg-green-400 flex items-center justify-center text-[8px] text-black font-bold transition-colors cursor-pointer" title="Fullscreen">
                                        +
                                    </button>
                                </div>
                                <span class="font-mono text-xs text-white/40">pong_engine_v1.js</span>
                            </div>
                            <Pong />
                        </div>
                    </div>
                </div>

                <div id="minimized-toast" class="mx-auto mt-12 w-fit bg-white/10 backdrop-blur-md border border-white/20 px-6 py-3 rounded-full text-sm font-mono text-cyan-400 pointer-events-auto cursor-pointer hover:bg-white/20 transition-all duration-300 opacity-0 z-50 shadow-lg shadow-cyan-500/20">
                    Game Minimized // Click Here to Restore
                </div>
            </section>

            <footer class="text-center py-12 text-white/20 text-sm font-mono pointer-events-auto">
                2026 // GOOBFACE LABS
            </footer>
        </main>
    </div>

    <script>
        // Space & Firework Engine
        const canvas = document.getElementById('space-canvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let particles = [];
        let stars = [];

        // Resize handling
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            initStars();
        }
        window.addEventListener('resize', resize);
        
        // Star System
        function initStars() {
            stars = [];
            const starCount = Math.floor((width * height) / 3000);
            for (let i = 0; i < starCount; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: Math.random() * 1.5,
                    opacity: Math.random(),
                    speed: Math.random() * 0.2
                });
            }
        }

        function drawStars() {
            stars.forEach(star => {
                ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Parallax movement
                star.y -= star.speed;
                if (star.y < 0) star.y = height;
            });
        }

        // Firework Particle System
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 10 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                
                this.life = 1.0;
                this.decay = Math.random() * 0.01 + 0.005;
                this.color = `hsl(${Math.random() * 60 + 180}, 100%, 70%)`; // Cyan/Blue range
                this.bounces = 0;
                this.gravity = 0.15;
            }

            update() {
                // Physics
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;

                // Bounce Logic (Screen edges)
                if (this.x <= 0 || this.x >= width) {
                    this.vx *= -0.8;
                    this.x = this.x <= 0 ? 0 : width;
                    this.bounces++;
                    this.decay = 0.05; // Fade out faster after bounce
                }
                if (this.y <= 0 || this.y >= height) {
                    this.vy *= -0.6; // Loss of energy
                    this.y = this.y <= 0 ? 0 : height;
                    this.bounces++;
                    this.decay = 0.05; // Fade out faster after bounce
                }

                // Disappear shortly after 1 bounce (interpreted as fast fade)
                if (this.bounces >= 1) {
                    this.life -= 0.02; 
                }

                this.life -= this.decay;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function createFirework(x, y) {
            const particleCount = 30 + Math.random() * 20; // Random sequence amount
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle(x, y));
            }
        }

        // Animation Loop
        function animate() {
            // Clear with trail effect
            ctx.fillStyle = 'rgba(5, 5, 16, 0.2)';
            ctx.fillRect(0, 0, width, height);

            drawStars();

            // Update Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update();
                p.draw();
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }

            requestAnimationFrame(animate);
        }

        // Init
        resize();
        animate();

        // Interaction
        document.addEventListener('click', (e) => {
            // Check if clicking interaction elements (links, buttons, game)
            // The pointer-events-none on main and pointer-events-auto on interactive elements 
            // handles CSS hover, but clicks bubble up.
            // We check composedPath to see if we clicked an anchor or button.
            const isInteractive = e.composedPath().some(el => 
                el instanceof HTMLElement && (
                    el.tagName === 'A' || 
                    el.tagName === 'BUTTON' || 
                    el.closest('#games') ||
                    el.id === 'minimized-toast'
                )
            );

            if (!isInteractive) {
                createFirework(e.clientX, e.clientY);
            }
        });

        // Fullscreen Toggle Logic
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const gameContainer = document.getElementById('game-container');

        fullscreenBtn?.addEventListener('click', async () => {
            if (!document.fullscreenElement) {
                try {
                    await gameContainer?.requestFullscreen();
                } catch (err) {
                    console.error(`Error attempting to enable fullscreen mode: ${err.message} (${err.name})`);
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        });

        // Close Button Logic
        const closeBtn = document.getElementById('close-btn');
        closeBtn?.addEventListener('click', () => {
            if (confirm('Terminate session?')) {
                window.close();
                // Fallback if window.close() is blocked (usually is unless pushed)
                window.location.href = 'about:blank';
            }
        });

        // Minimize Logic
        const minimizeBtn = document.getElementById('minimize-btn');
        const gamesArea = document.getElementById('games');
        const toast = document.getElementById('minimized-toast');
        let isMinimized = false;

        function toggleMinimize(shouldMinimize) {
            isMinimized = shouldMinimize;
            if (isMinimized) {
                // Fix: Exit fullscreen if active to prevent UI bugs
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => console.log(err));
                }
                gamesArea?.classList.add('hidden');
                toast?.classList.remove('opacity-0');
            } else {
                gamesArea?.classList.remove('hidden');
                toast?.classList.add('opacity-0');
            }
        }

        minimizeBtn?.addEventListener('click', () => toggleMinimize(true));

        // Restore: Click on Toast
        toast?.addEventListener('click', () => {
            if (isMinimized) toggleMinimize(false);
        });

    </script>
</Layout>
